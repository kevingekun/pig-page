import{S as m,o as j,P as f}from"./index.C0rhdPVG.js";import{a as l,a0 as R,r as c,m as b,j as x,$ as y,b as h,o as v}from"./vue.Bq5FSDyb.js";const $=l({name:"global-websocket"}),M=l({...$,props:{uri:{type:String}},emits:["rollback"],setup(g,{emit:p}){const u=p,T=g,e=R({webSocket:c(),lockReconnect:!1,maxReconnect:6,reconnectTime:0,heartbeat:{interval:3e4,timeout:1e4,pingTimeoutObj:c(),pongTimeoutObj:c(),pingMessage:JSON.stringify({type:"ping"})}}),a=b(()=>m.getToken()),k=b(()=>m.getTenant());x(()=>{i()}),y(()=>{e.webSocket.close(),s(e.heartbeat)});const i=()=>{let t=`ws://${window.location.host}https://pig.255032.xyz${j.adaptationUrl(T.uri)}?access_token=${a.value}&TENANT-ID=${k.value}`;e.webSocket=new WebSocket(t),e.webSocket.onopen=w,e.webSocket.onerror=S,e.webSocket.onmessage=d,e.webSocket.onclose=O},n=()=>{a&&(e.lockReconnect||e.maxReconnect!==-1&&e.reconnectTime>e.maxReconnect||(e.lockReconnect=!0,setTimeout(()=>{e.reconnectTime++,i(),e.lockReconnect=!1},5e3)))},s=t=>{t.pingTimeoutObj&&clearTimeout(t.pingTimeoutObj),t.pongTimeoutObj&&clearTimeout(t.pongTimeoutObj)},r=()=>{const t=e.webSocket,o=e.heartbeat;s(o),o.pingTimeoutObj=setTimeout(()=>{t.readyState===1?(t.send(o.pingMessage),o.pongTimeoutObj=setTimeout(()=>{t.close()},o.timeout)):n()},o.interval)},w=()=>{r(),e.reconnectTime=0},S=()=>{n()},O=()=>{n()},d=t=>{r();const o=t.data;o.indexOf("pong")>0||(f.warning({title:"\u6D88\u606F\u63D0\u9192",dangerouslyUseHTMLString:!0,message:o+"\u8BF7\u53CA\u65F6\u5904\u7406",offset:60}),u("rollback",o))};return(t,o)=>(v(),h("div"))}});export{M as default};
